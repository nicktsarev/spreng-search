version: '3.8'

services:
  nginx:
    image: nginx:1.25-alpine
    container_name: search_nginx
    ports:
      - "8080:80"
    volumes:
      - ./app:/srv/www/app:cached
      - ./deploy/containers/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php
    networks:
      - search_network

  php:
    build:
      context: ./deploy/containers/php
      dockerfile: Dockerfile
    container_name: search_php
    volumes:
      - ./app:/srv/www/app:cached
      - ./deploy/containers/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
    environment:
      DATABASE_URL: "mysql://searchuser:searchpass@mariadb:3306/searchdb?serverVersion=10.11.2-MariaDB&charset=utf8mb4"
      SPHINX_HOST: "sphinx"
      SPHINX_PORT: "9306"
      APP_ENV: "dev"
    depends_on:
      mariadb:
        condition: service_healthy
      sphinx:
        condition: service_started
    networks:
      - search_network
    command: >
      sh -c "
        composer install --no-interaction --optimize-autoloader &&
        php bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration &&
        php-fpm
      "

  mariadb:
    image: mariadb:10.11
    container_name: search_mariadb
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: searchdb
      MYSQL_USER: searchuser
      MYSQL_PASSWORD: searchpass
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./deploy/containers/mariadb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: >
      --innodb-buffer-pool-size=1G
      --ft-min-word-len=2
      --innodb-flush-log-at-trx-commit=2
      --innodb-log-file-size=256M
      --max-allowed-packet=256M
      --innodb-file-per-table=1
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - search_network

  sphinx:
    image: macbre/sphinxsearch:latest
    container_name: search_sphinx
    ports:
      - "9306:9306"
      - "9312:9312"
    volumes:
      - ./deploy/containers/sphinx/sphinx.conf:/opt/sphinx/conf/sphinx.conf:ro
      - sphinx_data:/opt/sphinx/index
      - sphinx_log:/opt/sphinx/log
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - search_network
    command: >
      sh -c "
        indexer --all --config /opt/sphinx/conf/sphinx.conf &&
        searchd --nodetach --config /opt/sphinx/conf/sphinx.conf
      "

networks:
  search_network:
    driver: bridge

volumes:
  mariadb_data:
  sphinx_data:
  sphinx_log: